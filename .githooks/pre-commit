#!/bin/bash
# ============================================================
# pre-commit hook ‚Äî Chiffrement automatique de k8s/secrets.yaml
# ============================================================
#
# Ce hook s'ex√©cute automatiquement avant chaque git commit.
# Si k8s/secrets.yaml existe, il est chiffr√© ‚Üí secrets.enc.yaml
# puis supprim√© pour √©viter toute fuite accidentelle.
#
# Installation (une seule fois) :
#   ./k8s/scripts/setup-dev.sh
#
# ============================================================

SECRETS_FILE="k8s/secrets.yaml"
ENC_FILE="k8s/secrets.enc.yaml"

# Rien √† faire si secrets.yaml n'existe pas
if [ ! -f "$SECRETS_FILE" ]; then
  exit 0
fi

echo "üîê secrets.yaml d√©tect√© ‚Äî chiffrement automatique..."

# V√©rifier que sops est install√©
if ! command -v sops &> /dev/null; then
  echo "‚ùå sops n'est pas install√©."
  echo "   ‚Üí apt install sops  ou  https://github.com/getsops/sops/releases"
  exit 1
fi

# V√©rifier que .sops.yaml a une vraie cl√© (pas le placeholder)
if grep -q "REMPLACER_PAR_TA_CLE_PUBLIQUE_AGE" .sops.yaml 2>/dev/null; then
  echo "‚ùå .sops.yaml contient encore le placeholder de cl√© age."
  echo "   ‚Üí Remplace 'age1REMPLACER_PAR_TA_CLE_PUBLIQUE_AGE' par ta vraie cl√© publique"
  echo "   ‚Üí G√©n√®re-la avec : age-keygen -o ~/.config/sops/age/keys.txt"
  exit 1
fi

# Chiffrer
if ! sops --encrypt "$SECRETS_FILE" > "$ENC_FILE"; then
  echo "‚ùå Erreur lors du chiffrement SOPS. Commit annul√©."
  rm -f "$ENC_FILE"
  exit 1
fi

# Stager le fichier chiffr√©
git add "$ENC_FILE"

# Supprimer le fichier en clair pour √©viter toute fuite
rm "$SECRETS_FILE"

echo "‚úÖ $ENC_FILE chiffr√© et ajout√© au commit."
echo "   $SECRETS_FILE supprim√© (ne sera jamais committ√©)."
