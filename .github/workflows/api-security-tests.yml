name: API Security Tests

on:
  workflow_run:
    workflows: ["Build and Push Backend"]
    types: [completed]
  workflow_dispatch:
    inputs:
      base_url:
        description: 'API base URL to test'
        required: false
        default: 'https://api.gauzian.com'

jobs:
  api-security-tests:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Hurl
        run: |
          curl -fSL https://github.com/Orange-OpenSource/hurl/releases/download/4.3.0/hurl_4.3.0_amd64.deb -o hurl.deb
          sudo apt-get install -y ./hurl.deb
          rm hurl.deb
          hurl --version

      - name: Set API URL
        id: set-url
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "api_url=${{ github.event.inputs.base_url }}" >> $GITHUB_OUTPUT
          else
            echo "api_url=${{ secrets.API_URL }}" >> $GITHUB_OUTPUT
          fi

      - name: Wait for API to be ready
        run: |
          API_URL="${{ steps.set-url.outputs.api_url }}"
          MAX_ATTEMPTS=20
          ATTEMPT=1
          echo "Waiting for API at $API_URL..."
          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$API_URL/health/ready" || echo "000")
            if [ "$HTTP_CODE" = "200" ]; then
              echo "API is ready!"
              exit 0
            fi
            echo "Attempt $ATTEMPT/$MAX_ATTEMPTS - HTTP $HTTP_CODE, retrying in 10s..."
            sleep 10
            ATTEMPT=$((ATTEMPT + 1))
          done
          echo "API failed to become ready"
          exit 1

      - name: Run API security tests
        run: |
          chmod +x tests/run_tests.sh
          tests/run_tests.sh \
            --base-url "${{ steps.set-url.outputs.api_url }}" \
            --email-a "${{ secrets.TEST_USER_EMAIL_A }}" \
            --email-b "${{ secrets.TEST_USER_EMAIL_B }}" \
            --password "${{ secrets.TEST_USER_PASSWORD }}" \
            --username-a "${{ secrets.TEST_USERNAME_A }}" \
            --username-b "${{ secrets.TEST_USERNAME_B }}" \
            --report-html

      - name: Upload test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: api-security-test-reports
          path: tests/reports/
          retention-days: 30
